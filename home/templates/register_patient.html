{% extends 'base.html' %}

{% block content %}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        resetForm();
    });
</script>


<h1>registrace pacienta</h1>
<button type="submit" id="reset">Resetovat</button>

<form method="post" enctype="multipart/form-data" id="patient-registration-form" autocomplete="off">
    {% csrf_token %}

    {{ patient_form.as_p }}

    <h3>Contacts</h3>
    {{ contact_formset.non_form_errors }}
    {{ contact_formset.errors }}

    <div id="contacts-formset" data-form-prefix="contacts" class="formset">
        {{ contact_formset.management_form }}
        <div class="empty-form" style="display: none;">
            {{ contact_formset.empty_form }}
        </div>
        {% for form in contact_formset %}
            <div class="formset-contacts">
                {{ form.empty_form.as_p }}
                {{ form.errors }}
            </div>
        {% endfor %}
    </div>
    <button type="button" id="add-contact">Add Contact</button>

    <h3>Medications</h3>
    {{ medication_formset.non_form_errors }}
    {{ medication_formset.errors }}

    <div id="medications-formset" data-form-prefix="medications" class="formset">
        {{ medication_formset.management_form }}
        <div class="empty-form" style="display: none;">
            {{ medication_formset.empty_form }}
        </div>
        {% for form in medication_formset %}
            <div class="formset-medications">
                {{ form.empty_form.as_p }}
                {{ form.errors }}
            </div>
        {% endfor %}
    </div>
    <button type="button" id="add-medication">Add Medication</button>

    <button type="submit" id="register-patient-btn">Register Patient</button>
</form>

<script>

    function resetForm() {
        $('#patient-registration-form')[0].reset();
        $('.formset-contacts').empty();
        $('.formset-medications').empty();
    }

   function addFormsetForm(formsetPrefix) {
        const managementForm = $(`#${formsetPrefix}-formset [id$='-TOTAL_FORMS']`);
        let totalForms = parseInt(managementForm.val());

        const emptyForm = $(`#${formsetPrefix}-formset .empty-form`).html();
        totalForms += 1;
        managementForm.val(totalForms + 1);

        const newForm = emptyForm.replace(/__prefix__/g, totalForms);
        const formsetContainer = $(`#${formsetPrefix}-formset`);
        formsetContainer.append(newForm);
    }

    $(document).ready(function() {

        // $('.datepicker').datepicker({
        //   dateFormat: 'yy-mm-dd',
        //   changeMonth: true,
        //   changeYear: true,
        // });

        $('#add-contact').on('click', function() {
            addFormsetForm('contacts');
        });

        $('#add-medication').on('click', function() {
            addFormsetForm('medications');
        });
    });
</script>

{% endblock %}